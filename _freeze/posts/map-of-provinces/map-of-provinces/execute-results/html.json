{
  "hash": "890e83e5e0b211d0ca18e7e366477253",
  "result": {
    "markdown": "---\ntitle: \"Map of the Dutch provinces\"\nauthor: \"Martijn van Bloois\"\ndate: \"2023-06-01\"\nexecute: \n  warning: false\ncategories: [maps, code, analysis]\nimage: \"image.jpg\"\n---\n\n\nPreparing for my upcoming blog post, I require a map showcasing the provinces of the Netherlands. Thankfully, the Dutch Central Bureau for Statistics (CBS) has the data I need. While the 2023 version solely includes the geometries, I will utilize the more comprehensive 2022 version, which offers additional information alongside the geometries.\n\n[Link to the Wijk- en buurtkaart 2022](https://www.cbs.nl/nl-nl/dossier/nederland-regionaal/geografische-data/wijk-en-buurtkaart-2022)\n\n[Link to Gemeentelijke indeling op 1 januari 2022](https://www.cbs.nl/nl-nl/onze-diensten/methoden/classificaties/overig/gemeentelijke-indelingen-per-jaar/indeling-per-jaar/gemeentelijke-indeling-op-1-januari-2022)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(readxl)\nlibrary(fs)\nlibrary(glue)\n```\n:::\n\n\n\nI download the shape file with municipalities I can use:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nversion <- \"2022_v1\"\nurl_map <- \n  glue(\"https://www.cbs.nl/-/media/cbs/dossiers/nederland-regionaal/wijk-en-buurtstatistieken/wijkbuurtkaart_{version}.zip\")\ndest_file <- glue(\"wijkbuurtkaart_{version}.zip\")\n\ndownload.file(url = url_map,\n              destfile = dest_file)\n\n# Just select the municipality files\nfiles <- unzip(dest_file, list = TRUE) %>% \n  filter(str_detect(Name, \"gemeente_\")) %>%\n  pull(Name)\n\nunzip(dest_file,\n      files = files)\n```\n:::\n\n\nThe municipality file does not contain a field for provinces.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl_decode <-\n  glue(\"https://www.cbs.nl/-/media/cbs/onze-diensten/methoden/classificaties/overig/gemeenten-alfabetisch-{str_sub(version, 1 ,4)}.xlsx\")\nxls_file <- glue(\"gemeenten-alfabetisch-{str_sub(version, 1 ,4)}.xlsx\")\ndownload.file(url = url_decode,\n              destfile = xls_file,\n              mode = \"wb\")\n```\n:::\n\n\nOnce we have downloaded the required files, we can start:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmunicipalities_2022 <- read_xlsx(xls_file)\n\nmunicipalities_2022\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 345 × 6\n   Gemeentecode GemeentecodeGM Gemeentenaam        Provinciecode ProvinciecodePV\n   <chr>        <chr>          <chr>               <chr>         <chr>          \n 1 1680         GM1680         Aa en Hunze         22            PV22           \n 2 0358         GM0358         Aalsmeer            27            PV27           \n 3 0197         GM0197         Aalten              25            PV25           \n 4 0059         GM0059         Achtkarspelen       21            PV21           \n 5 0482         GM0482         Alblasserdam        28            PV28           \n 6 0613         GM0613         Albrandswaard       28            PV28           \n 7 0361         GM0361         Alkmaar             27            PV27           \n 8 0141         GM0141         Almelo              23            PV23           \n 9 0034         GM0034         Almere              24            PV24           \n10 0484         GM0484         Alphen aan den Rijn 28            PV28           \n# ℹ 335 more rows\n# ℹ 1 more variable: Provincienaam <chr>\n```\n:::\n:::\n\n\nUse st_read from the {sf} package to load the shape file. I exclude the \"territorial waters\".\n\n\n::: {.cell}\n\n```{.r .cell-code}\nshape_file <- glue(\"./WijkBuurtkaart_{version}/gemeente_{version}.shp\")\n\nmunicipality_map <- st_read(shape_file,\n                            quiet = TRUE) %>% \n  filter(H2O == \"NEE\")\n```\n:::\n\n\n::: {.callout-note}\nNote: in 2022 the field is called H2O; in 2023 the field is called WATER.\n:::\n\nCombine the two files on municipality code. For me the magic happens in the group_by statement that combines the geometries into the new levels.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprovince_map <- municipality_map %>% \n  inner_join(\n    select(municipalities_2022, GemeentecodeGM, Provincienaam),\n    by = join_by(GM_CODE == GemeentecodeGM)\n  ) %>% \n  group_by(Provincienaam) %>% \n  summarise(population = sum(AANT_INW),\n            area = sum(OPP_LAND / 100)) %>% \n  mutate(pop_density = population / area)\n```\n:::\n\n\nPlot the newly made map.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(province_map,\n       aes(fill = pop_density))+\n  geom_sf() +\n  labs(caption = \"Source: Centraal Bureau voor de Statistiek\")\n```\n\n::: {.cell-output-display}\n![](map-of-provinces_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nWrite to map to a shape file for future use.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnew_file <- glue(\"provincie_{version}.shp\")\n\nst_write(province_map, new_file, append = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nDeleting layer `provincie_2022_v1' using driver `ESRI Shapefile'\nWriting layer `provincie_2022_v1' to data source \n  `provincie_2022_v1.shp' using driver `ESRI Shapefile'\nWriting 12 features with 4 fields and geometry type Unknown (any).\n```\n:::\n:::\n\n\nDelete the large downloads.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfs::dir_delete(glue(\"WijkBuurtkaart_{version}\"))\nfs::file_delete(c(dest_file, xls_file))\n```\n:::\n",
    "supporting": [
      "map-of-provinces_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}